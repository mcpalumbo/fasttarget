/*
 * FastTarget Nextflow Configuration
 * ==================================
 * Configuration file for FastTarget pipeline
 */

// Global default params
params {
    // Input parameters
    config_file = 'config.yml'
    databases_path = "${projectDir}/../databases"
    output_path = "${projectDir}/../organism"
    
    // Computational resources
    max_cpus = 4
    max_memory = '8.GB'
    max_time = '48.h'
    
    // Container engine (docker or singularity)
    container_engine = 'docker'
    
    // Enable/disable modules (can be overridden by config.yml)
    enable_structures = true
    enable_metabolism = true
    enable_core = true
    enable_offtarget = true
    enable_essentiality = true
    enable_localization = true
    enable_metadata = true
    
    // Enable/disable cache (set to false to force re-execution)
    enable_cache = true
    
    // Help message
    help = false
}

// Process configuration
process {
    // Default process settings
    cpus = 1
    memory = '4.GB'
    time = '4.h'
    
    // Error handling - terminate on failures
    errorStrategy = 'terminate'
    maxRetries = 0
    
    // Allow files outside work directory
    scratch = false
    
    // Process-specific resources
    withLabel: low_resources {
        cpus = 1
        memory = '2.GB'
        time = '2.h'
    }
    
    withLabel: medium_resources {
        cpus = { Math.min(2 * task.attempt, params.max_cpus) }
        memory = { 
            def memUnit = params.max_memory as nextflow.util.MemoryUnit
            def requested = (memUnit / 2) * task.attempt
            requested > memUnit ? memUnit : requested
        }
        time = { 4.h * task.attempt }
    }
    
    withLabel: high_resources {
        cpus = { Math.min(4 * task.attempt, params.max_cpus) }
        memory = { params.max_memory as nextflow.util.MemoryUnit }
        time = { 8.h * task.attempt }
    }
    
    withLabel: blast_process {
        cpus = { params.max_cpus }
        memory = { params.max_memory as nextflow.util.MemoryUnit }
        time = { 24.h * task.attempt }
    }
}

// Executor configuration
executor {
    name = 'local'
    queueSize = 4
}

// Container configuration
docker {
    enabled = false
    runOptions = '-u $(id -u):$(id -g)'
}

singularity {
    enabled = false
    autoMounts = true
}

apptainer {
    enabled = false
    autoMounts = true
}

// Profile configurations
profiles {
    standard {
        executor.name = 'local'
    }
    
    docker {
        docker.enabled = true
        singularity.enabled = false
        apptainer.enabled = false
    }
    
    singularity {
        singularity.enabled = true
        docker.enabled = false
        apptainer.enabled = false
    }
    
    apptainer {
        apptainer.enabled = true
        docker.enabled = false
        singularity.enabled = false
    }
    
    slurm {
        process.executor = 'slurm'
        process.queue = 'batch'
        executor.queueSize = 20
    }
    
    sge {
        process.executor = 'sge'
        process.queue = 'all.q'
        executor.queueSize = 20
    }
    
    pbs {
        process.executor = 'pbs'
        process.queue = 'batch'
        executor.queueSize = 20
    }
    
    test {
        params.max_cpus = 2
        params.max_memory = '4.GB'
        params.max_time = '2.h'
    }
}

// Report configuration
timeline {
    enabled = true
    file = "${params.output_path}/pipeline_info/timeline.html"
}

report {
    enabled = true
    file = "${params.output_path}/pipeline_info/report.html"
}

trace {
    enabled = true
    file = "${params.output_path}/pipeline_info/trace.txt"
}

dag {
    enabled = true
    file = "${params.output_path}/pipeline_info/dag.svg"
}

// Manifest
manifest {
    name = 'FastTarget'
    author = 'mcpalumbo'
    description = 'Nextflow pipeline for drug target identification'
    mainScript = 'main.nf'
    version = '1.0.0'
    nextflowVersion = '>=22.10.0'
}

// Cache configuration for all processes
// By default, all processes use cache according to params.enable_cache (default: true)
// To disable cache globally: use --enable_cache false
// To disable cache for specific processes: add 'withName' blocks below
process {
    cache = params.enable_cache
    
    // Uncomment and modify individual processes if needed:
    // withName: 'FASTTARGET:STRUCTURES_MERGE' {
    //     cache = false
    // }
    // withName: 'FASTTARGET:MERGE_FINAL_RESULTS' {
    //     cache = false
    // }
    
    // Available processes:
    // - FASTTARGET:GENOME_PREPARATION
    // - FASTTARGET:METABOLISM_PATHWAYTOOLS
    // - FASTTARGET:METABOLISM_SBML
    // - FASTTARGET:STRUCTURES_UNIPROT_MAPPING
    // - FASTTARGET:STRUCTURES_PREPARE
    // - FASTTARGET:STRUCTURES_DOWNLOAD_SINGLE
    // - FASTTARGET:STRUCTURES_EXTRACT_CHAINS
    // - FASTTARGET:STRUCTURES_COLABFOLD
    // - FASTTARGET:STRUCTURES_POCKETS_SINGLE
    // - FASTTARGET:STRUCTURES_POCKETS_COLLECT
    // - FASTTARGET:STRUCTURES_MERGE
    // - FASTTARGET:CONSERVATION_DOWNLOAD_GENOMES
    // - FASTTARGET:CONSERVATION_ROARY
    // - FASTTARGET:CONSERVATION_CORECRUNCHER
    // - FASTTARGET:OFFTARGET_HUMAN
    // - FASTTARGET:OFFTARGET_MICROBIOME
    // - FASTTARGET:OFFTARGET_FOLDSEEK
    // - FASTTARGET:ESSENTIALITY_DEG
    // - FASTTARGET:LOCALIZATION_PSORTB
    // - FASTTARGET:METADATA_LOADING
    // - FASTTARGET:MERGE_FINAL_RESULTS
}
